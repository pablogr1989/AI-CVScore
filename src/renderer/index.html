<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' file: data:; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com; img-src 'self' data: file:;">
    <title>CV AI Optimizer</title>
    <style>
        body { display: flex; flex-direction: column; height: 100vh; margin: 0; font-family: 'Montserrat', sans-serif; background: #1e1e1e; color: white; overflow: hidden; }
        .page { display: none; flex: 1; flex-direction: column; overflow: hidden; padding: 20px; }
        .page.active { display: flex; }
        .header { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }
        .footer { padding: 15px 20px; background: #2d2d2d; display: flex; justify-content: space-between; border-top: 1px solid #3c3c3c; }
        .content-area { display: flex; flex: 1; gap: 20px; overflow: hidden; }
        .input-panel { flex: 1; display: flex; flex-direction: column; gap: 8px; }
        .preview-panel { flex: 1; display: flex; flex-direction: column; background: white; border-radius: 4px; overflow: hidden; }
        .label { font-size: 11px; font-weight: bold; color: #888; text-transform: uppercase; }
        textarea { flex: 1; background: #252526; color: #d4d4d4; border: 1px solid #3c3c3c; padding: 12px; font-family: 'Consolas', monospace; font-size: 13px; resize: none; border-radius: 4px; outline: none; }
        textarea:focus { border-color: #007acc; }
        button { padding: 10px 20px; border-radius: 4px; font-weight: bold; border: none; cursor: pointer; transition: 0.2s; }
        button:disabled { background: #444 !important; color: #777 !important; cursor: not-allowed; opacity: 0.6; }
        .btn-primary { background: #007acc; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-ai { background: #6f42c1; color: white; }
        .btn-nav { background: #3e3e3e; color: white; }
        .btn-open { background: #ffc107; color: #212529; display: none; }
        iframe { width: 100%; height: 100%; border: none; }
        #status { font-size: 12px; color: #adb5bd; align-self: center; }
        #errorLog2 { background: #3d1010; color: #ff8888; padding: 10px; font-size: 12px; border-radius: 4px; margin-top: 10px; display: none; overflow-y: auto; max-height: 100px; }
        
        /* Estilos espec√≠ficos para el layout 50/50 de validaci√≥n */
        .split-panel { flex: 1; display: flex; flex-direction: column; gap: 15px; }
    </style>
</head>
<body>

    <div id="page1" class="page active">
        <div class="header">
            <h2>Paso 1: Configuraci√≥n e IA</h2>
            <button class="btn-ai" id="btnAI" onclick="generateFromAI()">‚ú® Generar CV con IA</button>
        </div>
        <div class="content-area">
            <div class="input-panel">
                <span class="label">Descripci√≥n de la Oferta</span>
                <textarea id="jobOffer" placeholder="Pega la oferta de trabajo aqu√≠..."></textarea>
                <span class="label">Mi Informaci√≥n Base (info.md)</span>
                <textarea id="personalInfo"></textarea>
            </div>
            <div class="input-panel">
                <span class="label">Especificaciones / Detalles Adicionales</span>
                <textarea id="specifications" placeholder="A√±ade aqu√≠ mejoras, c√≥mo enfocar el CV..."></textarea>
            </div>
        </div>
    </div>

    <div id="pageVal" class="page">
        <div class="header">
            <h2>Paso 2: Validaci√≥n de Compatibilidad</h2>
            <button class="btn-ai" id="btnRunValidation" onclick="runValidation()" disabled>üîç Calcular Score y Mejoras</button>
        </div>
        <div class="content-area">
            <div class="split-panel">
                <div class="input-panel" style="flex: 0.4;">
                    <span class="label">Oferta Analizada</span>
                    <textarea id="valJobOffer" readonly style="background: #2d2d2d; opacity: 0.8;"></textarea>
                </div>
                <div class="input-panel" style="flex: 0.6;">
                    <span class="label">CV Generado</span>
                    <textarea id="valCvEditor" placeholder="El CV generado aparecer√° aqu√≠ para validar..."></textarea>
                </div>
            </div>
            <div class="input-panel">
                <span class="label">Score y Comentarios de Mejora (IA)</span>
                <textarea id="valOutput" readonly placeholder="El an√°lisis de la IA aparecer√° aqu√≠..." style="border-color: #6f42c1;"></textarea>
            </div>
        </div>
    </div>

    <div id="page2" class="page">
        <div class="header">
            <h2>Paso 3: Edici√≥n y Exportaci√≥n</h2>
            <select id="templateSelect" onchange="updatePreview()">
                <option value="classic">Dise√±o Cl√°sico</option>
                <option value="modern">Dise√±o Moderno</option>
            </select>
            <button class="btn-nav" onclick="loadExternalCv()">üìÅ Cargar CV</button>
            <button class="btn-primary" id="btnSaveCV" onclick="saveCv()" disabled>üíæ Guardar CV</button>
            <button class="btn-success" id="btnExportPDF" onclick="exportPdf()" disabled>üìÑ Generar PDF</button>
            <button id="btnOpen" class="btn-open" onclick="openLastPdf()">Abrir PDF</button>
        </div>
        <div class="content-area">
            <div class="input-panel">
                <span class="label">Editor de CV (Markdown)</span>
                <textarea id="cvEditor" placeholder="Genera o carga un CV para editar..."></textarea>
            </div>
            <div class="preview-panel">
                <iframe id="preview"></iframe>
            </div>
        </div>
        <div id="errorLog2"></div>
    </div>

    <div class="footer">
        <button id="btnBack" class="btn-nav" onclick="navigateBack()" style="visibility: hidden;">‚¨ÖÔ∏è Anterior</button>
        <span id="status">Listo</span>
        <button id="btnNext" class="btn-nav" onclick="navigateNext()">Siguiente ‚û°Ô∏è</button>
    </div>

    <script>
        let currentCvPath = null;
        let lastPdfPath = null;
        let currentPage = 1;

        const cvEditor = document.getElementById('cvEditor');
        const valCvEditor = document.getElementById('valCvEditor');
        const status = document.getElementById('status');
        const btnSaveCV = document.getElementById('btnSaveCV');
        const btnExportPDF = document.getElementById('btnExportPDF');
        const btnRunValidation = document.getElementById('btnRunValidation');
        const errorLog2 = document.getElementById('errorLog2');

        window.onload = async () => {
            const info = await window.api.loadInfo();
            document.getElementById('personalInfo').value = info;
        };

        // L√≥gica de navegaci√≥n adaptada a 3 p√°ginas
        function showPage(num) {
            currentPage = num;
            document.getElementById('page1').classList.toggle('active', num === 1);
            document.getElementById('pageVal').classList.toggle('active', num === 2);
            document.getElementById('page2').classList.toggle('active', num === 3);
            
            document.getElementById('btnBack').style.visibility = (num > 1) ? 'visible' : 'hidden';
            document.getElementById('btnNext').style.visibility = (num < 3) ? 'visible' : 'hidden';
            
            if (num === 2) {
                // Sincronizar datos para la validaci√≥n
                document.getElementById('valJobOffer').value = document.getElementById('jobOffer').value;
                valCvEditor.value = cvEditor.value;
                validateValidationButton();
            }
            
            if (num === 3) {
                // Sincronizar cambios que se hayan hecho en la p√°gina de validaci√≥n de vuelta al editor
                cvEditor.value = valCvEditor.value;
                validateButtons();
                updatePreview();
            }
        }

        function navigateNext() { if (currentPage < 3) showPage(currentPage + 1); }
        function navigateBack() { if (currentPage > 1) showPage(currentPage - 1); }

        function validateButtons() {
            const isEmpty = !cvEditor.value.trim();
            btnSaveCV.disabled = isEmpty;
            btnExportPDF.disabled = isEmpty;
        }

        function validateValidationButton() {
            btnRunValidation.disabled = !valCvEditor.value.trim();
        }

        cvEditor.addEventListener('input', () => {
            validateButtons();
            debouncePreview();
        });

        valCvEditor.addEventListener('input', () => {
            validateValidationButton();
        });

        const debouncePreview = (() => {
            let timer;
            return () => {
                clearTimeout(timer);
                timer = setTimeout(updatePreview, 500);
            };
        })();

        async function updatePreview() {
            if (!cvEditor.value.trim()) return;
            const res = await window.api.renderPreview(cvEditor.value, document.getElementById('templateSelect').value);
            
            if (res.success) {
                const template = document.getElementById('templateSelect').value;
                let resourceBase = window.location.href.replace('src/renderer/index.html', '');
                if (resourceBase.includes('app.asar')) {
                    resourceBase = resourceBase.split('app.asar')[0];
                }
                
                let html = res.html.replace('<head>', `<head><base href="${resourceBase}templates/${template}/">`);
                html = html.replace(/src="profile\.(.*?)"/g, `src="${resourceBase}assets/profile.$1"`);
                
                document.getElementById('preview').srcdoc = html;
                errorLog2.style.display = 'none';
                status.innerText = "‚úÖ Preview actualizado";
            } else {
                errorLog2.innerText = res.error;
                errorLog2.style.display = 'block';
                status.innerText = "‚ùå Error en Preview";
            }
        }

        async function generateFromAI() {
            const job = document.getElementById('jobOffer').value;
            const info = document.getElementById('personalInfo').value;
            const specs = document.getElementById('specifications').value;
            
            if (!job || !info) return alert("Por favor, rellena al menos la oferta y tu perfil.");

            status.innerText = "ü§ñ OpenAI est√° optimizando tu CV...";
            document.getElementById('btnAI').disabled = true;
            try {
                const result = await window.api.generateCVAI(job, info, specs);
                cvEditor.value = result;
                validateButtons();
                showPage(2); // Ir a la nueva p√°gina de validaci√≥n tras generar
                status.innerText = "‚ú® CV Optimizado correctamente";
            } catch (e) {
                status.innerText = "‚ùå Error en IA";
                alert(e.message);
            } finally {
                document.getElementById('btnAI').disabled = false;
            }
        }

        // Nueva funci√≥n para ejecutar la validaci√≥n
        async function runValidation() {
            const job = document.getElementById('valJobOffer').value;
            const cv = valCvEditor.value;

            status.innerText = "üßê Analizando compatibilidad...";
            btnRunValidation.disabled = true;
            try {
                const result = await window.api.validateResumeAI(job, cv);
                document.getElementById('valOutput').value = result;
                status.innerText = "‚úÖ An√°lisis completado";
            } catch (e) {
                status.innerText = "‚ùå Error en Validaci√≥n";
                alert(e.message);
            } finally {
                btnRunValidation.disabled = false;
            }
        }

        async function loadExternalCv() {
            const file = await window.api.selectFile();
            if (file) {
                cvEditor.value = file.content;
                currentCvPath = file.path;
                validateButtons();
                updatePreview();
                status.innerText = `üìÇ Cargado: ${file.path}`;
            }
        }

        async function saveCv() {
            if (!currentCvPath) {
                alert("Debes cargar un archivo primero.");
                return;
            }
            await window.api.saveCV(cvEditor.value, currentCvPath);
            status.innerText = `‚úÖ Guardado en: ${currentCvPath}`;
        }

        async function exportPdf() {
            const dir = await window.api.selectDirectory();
            if (!dir) return;

            status.innerText = "Generando PDF...";
            try {
                const path = await window.api.generatePDF(cvEditor.value, document.getElementById('templateSelect').value, dir);
                lastPdfPath = path;
                document.getElementById('btnOpen').style.display = 'inline-block';
                status.innerText = `‚úÖ PDF Listo en: ${path}`;
            } catch (e) {
                alert("Error al generar PDF: " + e.message);
            }
        }

        function openLastPdf() {
            if (lastPdfPath) window.api.openPDF(lastPdfPath);
        }
    </script>
</body>
</html>